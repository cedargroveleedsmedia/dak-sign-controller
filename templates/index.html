<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>DAK Sign</title>
<style>
  :root {
    --bg:      #0f1117;
    --surface: #181c27;
    --border:  #252d3d;
    --orange:  #ff6b1a;
    --green:   #22c55e;
    --red:     #ef4444;
    --amber:   #f59e0b;
    --text:    #e2e8f0;
    --dim:     #64748b;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 16px; }

  /* Header */
  header {
    position: sticky; top: 0; z-index: 50;
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 0 16px; height: 56px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .logo { font-weight: 800; font-size: 18px; letter-spacing: -0.02em; color: #fff; }
  .logo em { color: var(--orange); font-style: normal; }
  #status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--dim); transition: background 0.3s; }
  #status-dot.ok  { background: var(--green); box-shadow: 0 0 6px var(--green); }
  #status-dot.err { background: var(--red);   box-shadow: 0 0 6px var(--red); }

  /* Main */
  main { padding: 16px; max-width: 640px; margin: 0 auto; padding-bottom: 100px; }

  /* Toast */
  #toast {
    position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(16px);
    background: #1e293b; border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 18px; font-size: 14px; white-space: nowrap;
    opacity: 0; transition: all 0.2s; z-index: 200; pointer-events: none;
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  #toast.ok  { border-color: var(--green); color: var(--green); }
  #toast.err { border-color: var(--red);   color: var(--red); }

  /* Section header */
  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .section-title { font-size: 12px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--dim); }

  /* Refresh btn */
  #refresh-btn {
    background: transparent; border: 1px solid var(--border); border-radius: 8px;
    color: var(--dim); padding: 6px 12px; font-size: 12px; cursor: pointer;
    display: flex; align-items: center; gap: 6px; transition: all 0.15s; font-family: inherit;
  }
  #refresh-btn:hover { border-color: var(--orange); color: var(--orange); }
  #refresh-btn.spinning svg { animation: spin 0.7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Message list */
  #msg-list { display: flex; flex-direction: column; gap: 8px; }
  .state-msg { text-align: center; padding: 48px 24px; color: var(--dim); font-size: 14px; }

  .msg-row {
    background: var(--surface); border: 1px solid var(--border);
    border-left-width: 3px; border-radius: 10px;
    padding: 14px 16px;
    display: flex; align-items: center; gap: 14px;
    transition: opacity 0.2s;
  }
  .msg-row.enabled  { border-left-color: var(--green); }
  .msg-row.disabled { border-left-color: var(--border); }
  .msg-row.busy     { opacity: 0.45; pointer-events: none; }

  .msg-name {
    flex: 1; font-weight: 600; font-size: 16px; color: var(--text);
    min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .msg-row.disabled .msg-name { color: var(--dim); }

  /* Toggle */
  .toggle { position: relative; width: 46px; height: 28px; flex-shrink: 0; cursor: pointer; display: block; }
  .toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
  .toggle-track { position: absolute; inset: 0; border-radius: 14px; background: var(--border); transition: background 0.2s; }
  .toggle input:checked ~ .toggle-track { background: var(--green); }
  .toggle-thumb { position: absolute; top: 4px; left: 4px; width: 20px; height: 20px; border-radius: 50%; background: #fff; transition: left 0.2s; box-shadow: 0 1px 4px rgba(0,0,0,0.5); }
  .toggle input:checked ~ .toggle-thumb { left: 22px; }

  /* Edit button */
  .edit-btn {
    flex-shrink: 0; width: 38px; height: 38px; border-radius: 8px;
    border: 1px solid var(--border); background: transparent;
    color: var(--dim); cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .edit-btn:hover { border-color: var(--orange); color: var(--orange); background: rgba(255,107,26,0.08); }

  /* FAB */
  #fab {
    position: fixed; bottom: 24px; right: 20px;
    width: 58px; height: 58px; border-radius: 50%;
    background: var(--orange); border: none; color: #fff;
    font-size: 28px; font-weight: 300; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 20px rgba(255,107,26,0.45);
    transition: transform 0.15s, box-shadow 0.15s; z-index: 50;
  }
  #fab:active { transform: scale(0.93); }

  /* Modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 100; align-items: flex-end; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 18px 18px 0 0; width: 100%; max-width: 640px;
    max-height: 90vh; overflow-y: auto;
    animation: slideUp 0.22s ease;
  }
  @keyframes slideUp { from { transform: translateY(32px); opacity: 0; } }
  .modal-pill { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto 0; }
  .modal-header { padding: 16px 20px 14px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
  .modal-title { font-weight: 700; font-size: 17px; }
  .modal-close { background: rgba(255,255,255,0.06); border: none; color: var(--dim); width: 30px; height: 30px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; }
  .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .modal-footer { padding: 16px 20px 28px; border-top: 1px solid var(--border); display: flex; gap: 10px; }

  /* Fields */
  .field label { display: block; font-size: 12px; font-weight: 600; color: var(--dim); margin-bottom: 7px; letter-spacing: 0.04em; }
  .field input[type=text], .field textarea {
    width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 10px;
    color: var(--text); font-size: 16px; padding: 12px 14px;
    outline: none; transition: border-color 0.15s; font-family: inherit;
  }
  .field input:focus, .field textarea:focus { border-color: var(--orange); }
  .field textarea { resize: vertical; min-height: 80px; line-height: 1.5; }

  /* Frame block */
  .frame-block { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 14px; display: flex; flex-direction: column; gap: 12px; }
  .frame-label { font-size: 11px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--amber); }

  /* Toggle row */
  .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 4px 0; }
  .toggle-row-label { font-size: 15px; font-weight: 500; }

  /* Buttons */
  .btn-primary {
    flex: 1; padding: 15px; border-radius: 10px; border: none;
    background: var(--orange); color: #fff; font-size: 16px; font-weight: 700;
    cursor: pointer; font-family: inherit; transition: background 0.15s;
  }
  .btn-primary:active { background: #e55a0d; }
  .btn-primary:disabled { background: var(--border); color: var(--dim); cursor: default; }
  .btn-ghost-danger {
    padding: 15px 18px; border-radius: 10px; border: 1px solid var(--red);
    background: transparent; color: var(--red); font-size: 15px; font-weight: 600;
    cursor: pointer; font-family: inherit;
  }
  .btn-ghost-danger:active { background: rgba(239,68,68,0.12); }
</style>
</head>
<body>

<header>
  <div class="logo">DAK <em>Sign</em></div>
  <div style="display:flex;align-items:center;gap:12px">
    <button id="refresh-btn" onclick="loadMessages()">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="flex-shrink:0"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M23 14l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
      Refresh
    </button>
    <div id="status-dot"></div>
  </div>
</header>

<main>
  <div class="section-header">
    <span class="section-title">Messages</span>
    <span id="msg-count" style="font-size:12px;color:var(--dim)"></span>
  </div>
  <div id="msg-list"><div class="state-msg">Loading…</div></div>
</main>

<button id="fab" onclick="openNewModal()" title="New message">+</button>
<div id="toast"></div>

<!-- Edit Modal -->
<div class="modal-overlay" id="edit-modal" onclick="closeBg(event)">
  <div class="modal-box">
    <div class="modal-pill"></div>
    <div class="modal-header">
      <span class="modal-title" id="edit-title">Edit</span>
      <button class="modal-close" onclick="close_('edit-modal')">×</button>
    </div>
    <div class="modal-body" id="edit-body"></div>
    <div class="modal-footer">
      <button class="btn-ghost-danger" id="del-btn" onclick="doDelete()">Delete</button>
      <button class="btn-primary" id="save-btn" onclick="doSave()">Save</button>
    </div>
  </div>
</div>

<!-- New Modal -->
<div class="modal-overlay" id="new-modal" onclick="closeBg(event)">
  <div class="modal-box">
    <div class="modal-pill"></div>
    <div class="modal-header">
      <span class="modal-title">New Message</span>
      <button class="modal-close" onclick="close_('new-modal')">×</button>
    </div>
    <div class="modal-body">
      <div class="field"><label>Name</label><input type="text" id="new-name" placeholder="e.g. Sunday Worship" autocomplete="off"></div>
      <div class="frame-block">
        <div class="frame-label">Frame 1 · Text</div>
        <div class="field"><textarea id="new-text" placeholder="Message text…" rows="3"></textarea></div>
      </div>
      <div class="toggle-row">
        <span class="toggle-row-label">Enabled</span>
        <label class="toggle"><input type="checkbox" id="new-enabled" checked><span class="toggle-track"></span><span class="toggle-thumb"></span></label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" id="create-btn" onclick="doCreate()">Create Message</button>
    </div>
  </div>
</div>

<script>
var _msgs = [], _cur = null;

// ── API ───────────────────────────────────────────────────────────
async function api(path, opts) {
  try {
    var r = await fetch(path, Object.assign({ headers: {'Content-Type':'application/json'} }, opts || {}));
    return { ok: r.ok, status: r.status, data: await r.json().catch(function(){return {};}) };
  } catch(e) { return { ok: false, data: { error: String(e) } }; }
}

// ── Toast ─────────────────────────────────────────────────────────
var _tt;
function toast(msg, type) {
  var el = document.getElementById('toast');
  el.textContent = msg; el.className = 'show ' + (type || '');
  clearTimeout(_tt); _tt = setTimeout(function(){ el.className=''; }, 3000);
}

// ── Dot ───────────────────────────────────────────────────────────
function dot(ok) { document.getElementById('status-dot').className = ok ? 'ok' : 'err'; }

// ── Load ──────────────────────────────────────────────────────────
async function loadMessages() {
  var rb = document.getElementById('refresh-btn');
  rb.classList.add('spinning');
  var r = await api('/api/messages');
  rb.classList.remove('spinning');
  if (!r.ok) { dot(false); list('<div class="state-msg">Cannot reach sign</div>'); toast('Cannot reach sign','err'); return; }
  dot(true);
  _msgs = (r.data.messages || []).filter(function(m){ return m.Name && m.Name.trim(); });
  document.getElementById('msg-count').textContent = _msgs.length + ' messages';
  if (!_msgs.length) { list('<div class="state-msg">No messages</div>'); return; }
  list(_msgs.map(function(m, i){
    var on = !!(m.CurrentSchedule && m.CurrentSchedule.Enabled);
    return '<div class="msg-row ' + (on?'enabled':'disabled') + '" id="r'+i+'">' +
      '<span class="msg-name">' + esc(m.Name) + '</span>' +
      '<label class="toggle"><input type="checkbox"' + (on?' checked':'') + ' onchange="doToggle('+i+',this.checked)">' +
        '<span class="toggle-track"></span><span class="toggle-thumb"></span></label>' +
      '<button class="edit-btn" onclick="openEdit('+i+')">' +
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>' +
      '</button>' +
    '</div>';
  }).join(''));
}

function list(h) { document.getElementById('msg-list').innerHTML = h; }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ── Toggle ────────────────────────────────────────────────────────
async function doToggle(i, on) {
  var m = _msgs[i], row = document.getElementById('r'+i);
  row.classList.add('busy');
  var r = await api('/api/messages/toggle', {method:'POST', body:JSON.stringify({name:m.Name, enabled:on})});
  row.classList.remove('busy');
  if (r.ok) {
    m.CurrentSchedule = m.CurrentSchedule || {};
    m.CurrentSchedule.Enabled = on;
    row.className = 'msg-row ' + (on ? 'enabled' : 'disabled');
    toast(m.Name + (on ? ' enabled' : ' disabled'), 'ok');
  } else {
    toast('Toggle failed', 'err');
    var cb = row.querySelector('input'); if(cb) cb.checked = !on;
  }
}

// ── Edit ──────────────────────────────────────────────────────────
function openEdit(i) {
  _cur = _msgs[i];
  document.getElementById('edit-title').textContent = _cur.Name;
  var on = !!(_cur.CurrentSchedule && _cur.CurrentSchedule.Enabled);
  var frames = _cur.Frames || [];
  var h = '<div class="field"><label>Name</label><input type="text" id="e-name" value="' + esc(_cur.Name) + '" autocomplete="off"></div>';
  frames.forEach(function(f,fi){
    h += '<div class="frame-block"><div class="frame-label">Frame ' + (fi+1) + '</div>';
    (f.Lines||[]).forEach(function(l,li){
      h += '<div class="field"><label>Line '+(li+1)+'</label><textarea id="e-f'+fi+'l'+li+'" rows="2">'+esc(l.Text||'')+'</textarea></div>';
    });
    h += '</div>';
  });
  h += '<div class="toggle-row"><span class="toggle-row-label">Enabled</span>' +
       '<label class="toggle"><input type="checkbox" id="e-enabled"'+(on?' checked':'')+'>' +
       '<span class="toggle-track"></span><span class="toggle-thumb"></span></label></div>';
  document.getElementById('edit-body').innerHTML = h;
  open_('edit-modal');
}

async function doSave() {
  var name = document.getElementById('e-name').value.trim();
  var on   = document.getElementById('e-enabled').checked;
  if (!name) { toast('Name required','err'); return; }
  var btn = document.getElementById('save-btn');
  btn.disabled = true; btn.textContent = 'Saving…';
  var frames = (_cur.Frames||[]).map(function(f,fi){
    return { frameIndex:fi, lines:(f.Lines||[]).map(function(_,li){ var el=document.getElementById('e-f'+fi+'l'+li); return el?el.value:''; }) };
  });
  var r = await api('/api/messages/update', {method:'POST', body:JSON.stringify({name:_cur.Name, newName:name, frames:frames, schedule:{Enabled:on}})});
  btn.disabled = false; btn.textContent = 'Save';
  if (r.ok) { toast('Saved','ok'); close_('edit-modal'); loadMessages(); }
  else toast((r.data&&r.data.error)||'Save failed','err');
}

async function doDelete() {
  if (!_cur || !confirm('Delete "'+_cur.Name+'"?')) return;
  var btn = document.getElementById('del-btn');
  btn.textContent = 'Deleting…';
  var r = await api('/api/messages/delete', {method:'POST', body:JSON.stringify({Name:_cur.Name})});
  btn.textContent = 'Delete';
  if (r.ok) { toast('"'+_cur.Name+'" deleted','ok'); close_('edit-modal'); loadMessages(); }
  else toast('Delete failed','err');
}

// ── New ───────────────────────────────────────────────────────────
function openNewModal() {
  document.getElementById('new-name').value='';
  document.getElementById('new-text').value='';
  document.getElementById('new-enabled').checked=true;
  open_('new-modal');
  setTimeout(function(){ document.getElementById('new-name').focus(); },250);
}

async function doCreate() {
  var name = document.getElementById('new-name').value.trim();
  var text = document.getElementById('new-text').value.trim();
  var on   = document.getElementById('new-enabled').checked;
  if (!name) { toast('Name required','err'); return; }
  if (!text)  { toast('Text required','err');  return; }
  var btn = document.getElementById('create-btn');
  btn.disabled=true; btn.textContent='Creating…';
  var r = await api('/api/messages/create', {method:'POST', body:JSON.stringify({name:name, text:text, fontSize:16, holdTime:'P0Y0M0DT0H0M5S', enabled:on})});
  btn.disabled=false; btn.textContent='Create Message';
  if (r.ok) { toast('"'+name+'" created','ok'); close_('new-modal'); loadMessages(); }
  else toast((r.data&&r.data.error)||'Create failed','err');
}

// ── Modal helpers ─────────────────────────────────────────────────
function open_(id)  { document.getElementById(id).classList.add('open');    document.body.style.overflow='hidden'; }
function close_(id) { document.getElementById(id).classList.remove('open'); document.body.style.overflow=''; }
function closeBg(e) { if(e.target===e.currentTarget) close_(e.currentTarget.id); }

// ── Boot ──────────────────────────────────────────────────────────
loadMessages();
</script>
</body>
</html>
